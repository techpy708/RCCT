{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}


<style>
  #client_selection_input {
    height: 38px;
    min-height: 38px;
    flex-shrink: 0;
  }
</style>

</script>
<section class="content">
  <div class="container-fluid">
    {% if messages %}
    <div class="mt-2">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="card card-primary mt-4">
      <div class="card-header">
        <h3 class="card-title">Add / Edit Notice Compliance</h3>
      </div>

      <form method="post" novalidate>
        {% csrf_token %}
        <div class="card-body">

          {% if user.department == "Accounts" %}
            <fieldset disabled>
          {% endif %}
          
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>Department</label>

              {% if user.department == "Admin" %}
              <select name="department" class="form-control" required>
                {% for value, label in form.fields.department.choices %}
                  <option value="{{ value }}" {% if form.instance.department == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
                {% else %}
                 <!-- Others: show readonly department -->
                <input type="text" class="form-control" value="{{ user.department }}" readonly>
                <input type="hidden" name="department" value="{{ user.department }}">
              {% endif %}
            </div>
            {% if user_role == "Executive" or user_role == "Manager" or user.department == "Admin" or user.department == "Accounts" %}
            <div class="form-group col-md-4">
              <label>Date of Receipt</label>
              <input type="date" name="date_of_receipt" class="form-control" value="{{ form.instance.date_of_receipt|date:'Y-m-d' }}">
            </div>

            <div class="form-group col-md-4">
              <label>Mode of Receipt</label>
              <input type="text" name="mode_of_receipt" class="form-control" value="{{ form.instance.mode_of_receipt }}">
            </div>
          </div>

          <div class="form-row">
            

            <!-- <div class="form-group col-md-4">
              <label for="id_group_code_selection">Group Code</label>
              <input type="text" name="group_code" class="form-control" value="{{ form.instance.group_code }}">
            </div> -->

            <div class="form-group col-md-4 d-flex flex-column">
              <label for="client_selection_input">Client</label>
              <select id="client_selection_input" name="client_selection" class="form-control form-control-lg">
                {% for value, label in form.fields.client_selection.choices %}
                  {% if value %}
                    <option value="{{ value }}" {% if form.initial.client_selection == value %}selected{% endif %}>{{ label }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>

            



            <div class="form-group col-md-4">
                <label for="id_group_selection">Group Code</label>
                {{ form.group_selection|add_class:"form-control" |attr:"disabled:true" }}
                {% if form.group_selection.errors %}
                  <small class="text-danger">{{ form.group_selection.errors|striptags }}</small>
                {% endif %}

            </div>

            
            

            <div class="form-group col-md-4">
              <label>Financial Year</label>
              <select name="financial_year" id="financial_year" class="form-control">
                {% for value, label in form.fields.financial_year.choices %}
                  <option value="{{ value }}" {% if form.initial.financial_year == value or form.instance.financial_year == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
                <label for="{{ form.asy.id_for_label }}">Assessment Year</label>
                {{ form.asy |add_class:"form-control" |attr:"disabled:true" }}
                {% if form.asy.errors %}
                    <div class="text-danger">{{ form.asy.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="form-group col-md-4">
              <label>Description of Work</label>
              <input type="text" name="description_of_work" class="form-control" value="{{ form.instance.description_of_work }}">
            </div>
               {% endif %}
            
            {% if user_role == "Manager" or  user.department == "Admin" or user.department == "Accounts" %}

            <div class="form-group col-md-4">
              <label>Action to be Taken</label>
              <input type="text" name="action_to_be_taken" class="form-control" value="{{ form.instance.action_to_be_taken }}">
            </div>

            <div class="form-group col-md-4">
              <label>Action Date</label>
              <input type="date" name="action_date" class="form-control" value="{{ form.instance.action_date|date:'Y-m-d' }}">
            </div>

            <div class="form-group col-md-4">
              <label>Progress</label>
              <input type="text" name="progress" class="form-control" value="{{ form.instance.progress }}">
            </div>

            <div class="form-group col-md-4">
              <label>Status</label>
              <select name="status" class="form-control">
                {% for value, label in form.fields.status.choices %}
                  <option value="{{ value }}" {% if form.instance.status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group col-md-4">
              <label>Status Date</label>
              <input type="date" name="status_date" class="form-control" value="{{ form.instance.status_date|date:'Y-m-d' }}">
            </div>

            <div class="form-group col-md-4">
              <label>Remarks</label>
              <input type="text" name="remarks" class="form-control" value="{{ form.instance.remarks }}">
            </div>

            <div class="form-group col-md-4">
              <label>Date of Task Completion</label>
              <input type="date" name="date_of_task_completion" class="form-control" value="{{ form.instance.date_of_task_completion|date:'Y-m-d' }}">
            </div>
          {{ endif }}
          

          {% if user.department == "Accounts" %}
            </fieldset>
          {% endif %}

          {% if  user.department == "Admin" or user.department == "Accounts" %}

            {% if form.fields.billing_status %}
              <div class="form-group col-md-4">
                <label>Billing Status</label>
                <select name="billing_status" class="form-control">
                  <option value="" {% if not form.instance.billing_status %}selected{% endif %}>-- Select --</option>
                  {% for value, label in form.fields.billing_status.choices %}
                    <option value="{{ value }}" {% if form.instance.billing_status == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}

            {% if form.fields.billing_amount %}
              <div class="form-group col-md-4">
                <label>Billing Amount</label>
                <input type="number" step="0.01" name="billing_amount" class="form-control" value="{{ form.instance.billing_amount }}">
              </div>
            {% endif %}

            {% if form.fields.bill_no %}
              <div class="form-group col-md-4">
                <label>Bill No</label>
                <input type="text" name="bill_no" class="form-control" value="{{ form.instance.bill_no }}">
              </div>
            {% endif %}

            {% if form.fields.bill_date %}
              <div class="form-group col-md-4">
                <label>Bill Date</label>
                {{ form.bill_date|add_class:"form-control" }}

              </div>
            {% endif %}

          </div>
          {% endif %}
          {% endif %}
        </div>

        <div class="card-footer text-left">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
    </div>
  </div>
</section>



<script src="{% static 'dashboard/plugins/jquery/jquery.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const clientSelect = document.getElementById('id_client_selection');
    const groupSelect = document.getElementById('id_group_selection');

    function updateGroupCodeFromClient() {
        const selectedOption = clientSelect.options[clientSelect.selectedIndex].value;
        if (!selectedOption.includes('|||')) return;

        const parts = selectedOption.split('|||');
        const groupCode = parts[2];

        // Auto-select the group_code in group_selection
        for (let i = 0; i < groupSelect.options.length; i++) {
            if (groupSelect.options[i].value === groupCode) {
                groupSelect.selectedIndex = i;
                break;
            }
        }
    }

    if (clientSelect && groupSelect) {
        // On change
        clientSelect.addEventListener('change', updateGroupCodeFromClient);

        // On page load (for edit form)
        updateGroupCodeFromClient();
    }

    
});
</script>

<script>
function updateAssessmentYear() {
    console.log("updateAssessmentYear triggered");

    const fySelect = document.getElementById('financial_year');
    const ayField = document.getElementById('{{ form.asy.id_for_label }}');

    if (!fySelect || !ayField) {
        console.warn("Missing FY or AY field");
        return;
    }

    const selectedFY = fySelect.value;
    console.log("Selected Financial Year:", selectedFY);

    if (selectedFY) {
        const parts = selectedFY.split('-');
        if (parts.length === 2) {
            const startYear = parseInt(parts[0], 10);
            if (!isNaN(startYear)) {
                const ayStartYear = startYear + 1; // e.g., 2010 + 1 = 2011
                const ayEndYearFull = startYear + 2; // e.g., 2010 + 2 = 2012
                let ayEndYearShort = (ayEndYearFull % 100).toString(); // "12"
                if (ayEndYearShort.length === 1) {
                    ayEndYearShort = '0' + ayEndYearShort;
                }

                const assessmentYear = `${ayStartYear}-${ayEndYearShort}`;
                console.log("Calculated Assessment Year:", assessmentYear);

                if (ayField.tagName.toLowerCase() === 'select') {
                    let found = false;
                    for (let option of ayField.options) {
                        if (option.value === assessmentYear || option.text === assessmentYear) {
                            ayField.value = option.value;
                            found = true;
                            console.log("Assessment Year select updated to:", ayField.value);
                            break;
                        }
                    }
                    if (!found) {
                        console.warn("Assessment Year not found in select options.");
                    }
                } else if (ayField.tagName.toLowerCase() === 'input') {
                    ayField.value = assessmentYear;
                    console.log("Assessment Year input updated to:", ayField.value);
                }
            }
        }
    }
}

window.addEventListener('load', updateAssessmentYear);
document.addEventListener('DOMContentLoaded', function () {
    const fySelect = document.getElementById('financial_year');
    if (fySelect) {
        fySelect.addEventListener('change', updateAssessmentYear);
    }
});
</script>

<script>
  $(document).ready(function () {
    const $clientSelect = $('#client_selection_input');
    const $groupSelect = $('#id_group_selection');

    $clientSelect.select2({
      tags: true,
      placeholder: 'Select or type a client',
      width: '100%'
    });

    function updateGroupFromClient(value) {
      if (value.includes('|||')) {
        const parts = value.split('|||');
        const groupCode = parts[2];

        // Update group code field
        $groupSelect.val(groupCode).trigger('change');
      }
    }

    // Handle selection from list or custom entry
    $clientSelect.on('change', function (e) {
      const selectedVal = $(this).val();
      updateGroupFromClient(selectedVal);
    });

    // Run on page load too (e.g. edit form)
    const initialVal = $clientSelect.val();
    if (initialVal) {
      updateGroupFromClient(initialVal);
    }
  });
</script>



{% endblock %}
