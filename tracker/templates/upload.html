{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-5">
    <h2>Upload Document</h2>
    <form method="POST" enctype="multipart/form-data" class="mb-4">
      {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-3">
              {{ form.nature_of_agreement.label_tag }}<span class="text-danger">*</span>
              {{ form.nature_of_agreement }}
              {% if form.nature_of_agreement.errors %}
                <div class="text-danger">{{ form.nature_of_agreement.errors.0 }}</div>
              {% endif %}
          </div>
          <div class="form-group col-md-3">
              {{ form.party_name.label_tag }}<span class="text-danger">*</span>
              {{ form.party_name }}
              {% if form.party_name.errors %}
                <div class="text-danger">{{ form.party_name.errors.0 }}</div>
              {% endif %}

          </div>
          <div class="form-group col-md-3">
              {{ form.from_date.label_tag }}<span class="text-danger">*</span>
              {{ form.from_date }}
              {% if form.from_date.errors %}
                <div class="text-danger">{{ form.from_date.errors.0 }}</div>
              {% endif %}
          </div>
          <div class="form-group col-md-3">
              {{ form.to_date.label_tag }}<span class="text-danger">*</span>
              {{ form.to_date }}
              {% if form.to_date.errors %}
                <div class="text-danger">{{ form.to_date.errors.0 }}</div>
              {% endif %}
          </div>
          <div class="form-group col-md-3">
            <label for="id_group">Group</label><span class="text-danger">*</span>
            <select name="group" id="id_group" class="form-control" required>
              <option value="">Select Group</option>
              {% for g in groups %}
                <option value="{{ g.id }}" {% if form.initial.group.id == g.id %}selected{% endif %}>{{ g.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group col-md-3">
            <label for="id_company">Company</label><span class="text-danger">*</span>
            <select name="company" id="id_company" class="form-control" required>
              <option value="">Select Company</option>
              {% for c in companies %}
                <option value="{{ c.id }}" data-group="{{ c.group_id }}" {% if form.initial.company.id == c.id %}selected{% endif %}>
                  {{ c.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group col-md-3">
            <label for="id_department">Department</label><span class="text-danger">*</span>
            <select name="department" id="id_department" class="form-control" required>
              <option value="">Select Department</option>
              {% for d in departments %}
                <option value="{{ d.id }}" data-company="{{ d.company_id }}" {% if form.initial.department.id == d.id %}selected{% endif %}>
                  {{ d.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          

          <div class="form-group col-md-3">
              {{ form.email.label_tag }}<span class="text-danger">*</span>
              {{ form.email }}
              {% if form.email.errors %}
                <div class="text-danger">{{ form.email.errors.0 }}</div>
              {% endif %}
          </div>
          <div class="form-group col-md-3">
              {{ form.file.label_tag }}<span class="text-danger">*</span>
              {{ form.file }}
              {% if form.file.errors %}
                <div class="text-danger">{{ form.file.errors.0 }}</div>
              {% endif %}
          </div>
      </div>
      <button type="submit" class="btn btn-primary">Upload</button>
    </form>

    <div class="p-3">
      <input type="text" id="userSearch" class="form-control" placeholder="Search...">
    </div>
    <hr>

    <h4>Uploaded Documents</h4>
    {% if documents %}
    <div class="table-responsive">
      <table class="table table-striped table-bordered">
          <thead class="thead-dark">
              <tr>
                  <th>Nature of Agreement</th>
                  <th>Party Name</th>
                  <th>From Date</th>
                  <th>To Date</th>
                  <th>Group</th>
                  <th>Company</th>
                  <th>Department</th>
                   <th>Email</th>
                  <th>Versions</th>
                  <th>Actions</th>
              </tr>
          </thead>
          <tbody>
              {% for doc in documents %}
              <tr data-doc-id="{{ doc.id }}">
                  <td>{{ doc.nature_of_agreement }}</td>
                  <td>{{ doc.party_name }}</td>
                  <td>{{ doc.from_date|date:"d-m-Y" }}</td>
                  <td>{{ doc.to_date|date:"d-m-Y" }}</td>
                  <td>{{ doc.group.name }}</td>
                  <td>{{ doc.company.name }}</td>
                  <td>{{ doc.department.name }}</td>
                  <td>{{ doc.email }}</td>
                  
                  <!-- <td><a href="{{ doc.file.url }}" target="_blank">Download</a></td>   old version download> -->
                  
                  
                  <td>
                    {% if doc.versions.all %}
                
                        <form onsubmit="return compareVersions('{{ doc.id }}');">
                          <ul class="list-unstyled mb-0">
                            {% for version in doc.versions.all|dictsortreversed:"uploaded_at" %}
                              <li>
                                <input type="checkbox" name="version_id" value="{{ version.id }}" class="version-checkbox-{{ doc.id }}">
                                <span class="badge badge-light">{{ version.version_label }}</span>
                  
                                <a href="{% url 'secure_file_download' version.id %}">
                                  {{ version.file.name|cut:"documents/versions/" }}
                                </a>
                  
                                {% if forloop.first %}
                                  <span class="badge badge-success">Latest</span>
                                {% endif %}
                                <small class="text-muted">({{ version.uploaded_at|date:"d M Y H:i" }})</small><br>
                                <small class="text-muted">Changelog: {{ version.changelog|default:"No changelog" }}</small><br>

                                
                              </li>
                            {% endfor %}
                          </ul>
                          <button type="submit" class="btn btn-sm btn-warning mt-1">Compare</button>
                          <div class="text-info mt-1" id="compare-status-{{ doc.id }}" style="display:none;">Processing...</div>
                        </form>
                      
                    {% else %}
                      <small class="text-muted">No versions</small>
                    {% endif %}
                  </td>
                  

<!-- 
                  <td>
                    <div class="d-flex flex-column gap-1">
                      <a href="{% url 'add_version' doc.id %}" class="btn btn-sm btn-info mb-1">Add Version</a>

                      <button type="button"
                              class="btn btn-sm btn-secondary mb-1"
                              id="addendum-btn-{{ doc.id }}"
                              onclick="handleAddendum('{{ doc.id }}')"
                              style="display: none;">
                        Add Addendum
                      </button>

                      <a href="{% url 'delete_document' doc.id %}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Are you sure you want to delete this document and all its versions?');">
                        Delete
                      </a>
                    </div>
                  </td> -->
                  

                  <td>
                    
                      <div class="d-flex flex-column gap-1">
                        <a href="{% url 'add_version' doc.id %}" class="btn btn-sm btn-info mb-1">Add Version</a>
                  
                        <button type="button"
                                class="btn btn-sm btn-secondary mb-1"
                                id="addendum-btn-{{ doc.id }}"
                                onclick="handleAddendum('{{ doc.id }}')"
                                style="display: none;">
                          Add Addendum
                        </button>
                        
<!--                         
                        <a href="{% url 'delete_document' doc.id %}" class="btn btn-sm btn-danger"
                          onclick="return confirm('Are you sure you want to delete this document and all its versions?');">
                          Delete All
                        </a> -->
                        {% if request.user.access_rights != 'download' %}
                        <a href="#"
                          class="btn btn-sm btn-danger"
                          data-toggle="modal"
                          data-target="#confirmDeleteModal"
                          data-doc-id="{{ doc.id }}">
                          Delete All
                        </a>

                        <!-- Hidden form to submit when confirmed -->
                        <form id="deleteForm-{{ doc.id }}"
                              method="POST"
                              action="{% url 'delete_document' doc.id %}"
                              style="display: none;">
                          {% csrf_token %}
                        </form>


                        
                        <form method="POST"
                              action="{% url 'delete_selected_version' %}"
                              class="delete-version-form"
                              style="display: none; width: 100%;">
                          {% csrf_token %}
                          <input type="hidden" name="version_id" class="selected-version-id">
                          <button type="submit" class="btn btn-sm btn-danger w-100 mt-1">Delete Selected</button>
                        </form>
                        {% endif %}
                        
                      </div>
                 
                  </td>
                  
              </tr>
              {% endfor %}
          </tbody>
      </table>
    </div>
    {% else %}
    <p>No documents uploaded yet.</p>
    {% endif %}
</div>
<!-- Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this document and all its versions?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Yes</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}


{% block extra_scripts %}
<script src="{% static 'dashboard/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'dashboard/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'dashboard/plugins/cloudflare/pdf.min.js' %}"></script>


<script>
function compareVersions(docId) {
  const checkboxes = document.querySelectorAll(`.version-checkbox-${docId}:checked`);
  const statusEl = document.getElementById(`compare-status-${docId}`);

  if (checkboxes.length !== 2) {
    alert("Please select exactly 2 versions to compare.");
    return false;
  }

  const version1 = checkboxes[0].value;
  const version2 = checkboxes[1].value;

  // Show status
  if (statusEl) {
    statusEl.style.display = 'block';
    statusEl.innerText = 'Processing comparison... Please wait.';
  }

  const url = `/compare/${docId}/${version1}/${version2}/`;
  window.location.href = url;

  return false;
}


function handleAddendum(docId) {
    const checkboxes = document.querySelectorAll(`.version-checkbox-${docId}:checked`);
    if (checkboxes.length !== 1) {
      alert("Select exactly one version to add addendum to.");
      return;
    }
    const versionId = checkboxes[0].value;
    window.location.href = `/add-addendum/${versionId}/`;
  }

  $(document).ready(function() {
    $('#userSearch').on('keyup', function() {
      const searchTerm = $(this).val().toLowerCase();
      $('table tbody tr').each(function() {
        const rowText = $(this).text().toLowerCase();
        $(this).toggle(rowText.includes(searchTerm));
      });
    });
  });
  

function updateActionButtons(docId) {
  const checkboxes = document.querySelectorAll(`.version-checkbox-${docId}`);
  const addendumBtn = document.getElementById(`addendum-btn-${docId}`);
  const deleteForm = document.querySelector(`tr[data-doc-id="${docId}"] .delete-version-form`);
  const versionIdInput = deleteForm?.querySelector('.selected-version-id');

  const checked = Array.from(checkboxes).filter(cb => cb.checked);

  if (addendumBtn) {
    addendumBtn.style.display = checked.length === 1 ? 'inline-block' : 'none';
  }

  if (deleteForm && versionIdInput) {
    if (checked.length === 1) {
      deleteForm.style.display = 'block';
      versionIdInput.value = checked[0].value;
    } else {
      deleteForm.style.display = 'none';
      versionIdInput.value = '';
    }
  }
}





document.addEventListener("DOMContentLoaded", () => {
  // Password strength
  const pwd = document.getElementById("id_password1");
  const strengthContainer = document.getElementById("password-strength");
  const strengthText = strengthContainer?.querySelector("span");

  if (pwd && strengthText) {
    pwd.addEventListener("input", () => {
      const val = pwd.value;
      if (!val) {
        strengthContainer.style.display = "none";
        return;
      }

      strengthContainer.style.display = "block";

      const score = [/[a-z]/, /[A-Z]/, /\d/, /[^A-Za-z0-9]/].reduce((s, r) => s + r.test(val), 0) + (val.length >= 8 ? 1 : 0);
      const levels = ["Very Weak", "Weak", "Fair", "Good", "Strong", "Very Strong"];
      const colors = ["text-danger", "text-danger", "text-warning", "text-info", "text-primary", "text-success"];

      strengthText.textContent = levels[score];
      strengthText.className = colors[score];
    });
  }

  // Checkbox listener
  const allCheckboxes = document.querySelectorAll('[class^="version-checkbox-"]');
  allCheckboxes.forEach(cb => {
    cb.addEventListener('change', function () {
      const classList = Array.from(cb.classList);
      const versionClass = classList.find(c => c.startsWith('version-checkbox-'));
      if (versionClass) {
        const docId = versionClass.replace('version-checkbox-', '');
        updateActionButtons(docId);
      }
    });
  });

  const groupSelect = document.getElementById('id_group');
  const companySelect = document.getElementById('id_company');
  const departmentSelect = document.getElementById('id_department');

  function filterCompaniesByGroup() {
    const groupId = groupSelect.value;
    [...companySelect.options].forEach(opt => {
      opt.style.display = (!groupId || opt.dataset.group == groupId || opt.value == "") ? 'block' : 'none';
    });
    companySelect.value = "";
    filterDepartmentsByCompany();  // reset department
  }

  function filterDepartmentsByCompany() {
    const companyId = companySelect.value;
    [...departmentSelect.options].forEach(opt => {
      opt.style.display = (!companyId || opt.dataset.company == companyId || opt.value == "") ? 'block' : 'none';
    });
    departmentSelect.value = "";
  }

  groupSelect?.addEventListener('change', filterCompaniesByGroup);
  companySelect?.addEventListener('change', filterDepartmentsByCompany);

  filterCompaniesByGroup();  // initial
  filterDepartmentsByCompany();
});



</script>

<script>
  let deleteDocId = null;

  // Capture which <a> was clicked before showing modal
  $('#confirmDeleteModal').on('show.bs.modal', function (event) {
    const trigger = $(event.relatedTarget);  // the <a> tag
    deleteDocId = trigger.data('doc-id');    // store the document ID
  });

  // Submit the form for that document when confirm is clicked
  $('#confirmDeleteBtn').on('click', function () {
    if (deleteDocId !== null) {
      const form = document.getElementById(`deleteForm-${deleteDocId}`);
      if (form) form.submit();
    }
  });
</script>





{% endblock %}