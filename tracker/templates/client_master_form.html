{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<style>
  select[multiple] {
    height: auto;
  }
</style>
<script href="{% static 'dashboard/plugins/select2/js/select2.min.css' %}" rel="stylesheet"></script>

<section class="content">
  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">Are you sure you want to delete this client?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-md-12">

        <!-- Add/Edit Client Form -->
        <div class="card card-primary mt-4">
          <div class="card-header">
            <h3 class="card-title">{% if edit_client %} Edit Client {% else %} Add New Client {% endif %}</h3>
          </div>

          <form method="post">
            {% csrf_token %}
            {% if edit_client %}
              <input type="hidden" name="client_id" value="{{ edit_client.id }}">
            {% endif %}

            <div class="card-body">
              <div class="row">

                <!-- Group Code -->
                  <div class="col-md-4">
                  <div class="form-group">
                    <label for="id_group_code">Group Code</label>
                    <input type="text" name="group_code" id="id_group_code"
                            value="{{ form.group_code.value|default_if_none:'' }}" class="form-control">
                    {% if form.group_code.errors %}
                      <small class="text-danger">{{ form.group_code.errors|striptags }}</small>
                    {% endif %}
                  </div>
                  </div>

                  <!-- Client Code -->
                  <div class="col-md-4">
                  <div class="form-group">
                    <label for="id_client_code">Client Code</label>
                    <input type="text" name="client_code" id="id_client_code"
                            value="{{ form.client_code.value|default_if_none:'' }}" class="form-control">
                    {% if form.client_code.errors %}
                      <small class="text-danger">{{ form.client_code.errors|striptags }}</small>
                    {% endif %}
                  </div>
                  </div>


                <!-- Client Name -->
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="id_client_name">Client Name</label>
                    <input type="text" name="client_name" id="id_client_name"
                           value="{{ form.client_name.value|default_if_none:'' }}" class="form-control">
                    {% if form.client_name.errors %}
                      <small class="text-danger">{{ form.client_name.errors|striptags }}</small>
                    {% endif %}
                  </div>
                </div>

                <!-- Group Code -->

                <div class="col-md-4">
                  <div class="form-group">
                    <label for="id_nature_of_client">Nature of Client</label>
                    <input type="text" name="nature_of_client" id="id_nature_of_client"
                           value="{{ form.nature_of_client.value|default_if_none:'' }}" class="form-control">
                    {% if form.nature_of_client.errors %}
                      <small class="text-danger">{{ form.nature_of_client.errors|striptags }}</small>
                    {% endif %}
                  </div>
                </div>


                <div class="form-group col-md-4">
                <div class="form-group">
                    <label for="id_nature_of_client">Nature of Client</label>
                {{ form.nature_of_client|add_class:"form-control" }}
                {% if form.nature_of_client.errors %}
                  <small class="text-danger">{{ form.nature_of_client.errors|striptags }}</small>
                {% endif %}
                </div>
            </div>
                

                <!-- Email -->
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="id_email">Email</label>
                    <input type="email" name="email" id="id_email"
                           value="{{ form.email.value|default_if_none:'' }}" class="form-control">
                    {% if form.email.errors %}
                      <small class="text-danger">{{ form.email.errors|striptags }}</small>
                    {% endif %}
                  </div>
                </div>

                <!-- Phone Number -->
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="id_phone_number">Phone Number</label>
                    <input type="text" name="phone_number" id="id_phone_number"
                           value="{{ form.phone_number.value|default_if_none:'' }}" class="form-control">
                    {% if form.phone_number.errors %}
                      <small class="text-danger">{{ form.phone_number.errors|striptags }}</small>
                    {% endif %}
                  </div>
                </div>

                <!-- Nature of Client -->
                

                <!-- Department -->
                         <div class="col-md-6">
                  <div class="form-group">
                    <label for="id_department">Department</label>
                    <select name="department" id="id_department" multiple class="form-control">
                      {% for value, label in form.department.field.choices %}
                        <option value="{{ value }}"
                          {% if value in form.department.value %}selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                    
                  </div>
                </div>

              </div>
            </div>

            <div class="card-footer">
              <button type="submit" class="btn btn-primary btn-block">
                {% if edit_client %} <i class="fas fa-save"></i> Update Client
                {% else %} <i class="fas fa-plus"></i> Add Client
                {% endif %}
              </button>
            </div>
          </form> 
        </div>

        {% if messages %}
          <div class="alert alert-success">
            {% for message in messages %}
              {{ message }}
            {% endfor %}
          </div>
        {% endif %}

        <!-- Existing Clients Table -->
        <div class="card card-secondary">
          <div class="card-header">
            <h3 class="card-title">Existing Clients</h3>
          </div>
          <div class="card-body">
            <table class="table table-striped table-bordered datatable">
              <thead>
                <tr>
                  <th style="width: 120px;">Actions</th>
                  <th>Client Code</th>
                  <th>Client Name</th>
                  <th>Group Code</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Nature</th>
                  <th>Department</th>
                  
                </tr>

                <tr>
                <th></th> <!-- For ID -->
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>
                <th><select class="form-control form-control-sm column-filter"><option value="">All</option></select></th>

                
            </tr>

              </thead>
              <tbody>
                {% for client in clients %}
                  <tr>
                    <td>
                      <a href="{% url 'view_clients' %}?edit={{ client.id }}" class="btn btn-sm btn-warning">
                        <i class="fas fa-edit"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-danger"
                         data-toggle="modal"
                         data-target="#confirmDeleteModal"
                         data-client-id="{{ client.id }}">
                        <i class="fas fa-trash-alt"></i>
                      </a>
                    </td>
                    <td>{{ client.client_code }}</td>
                    <td>{{ client.client_name }}</td>
                    <td>{{ client.group_code }}</td>
                    <td>{{ client.email }}</td>
                    <td>{{ client.phone_number }}</td>
                    <td>{{ client.nature_of_client }}</td>
                    <td>
                      {% for dept in client.department %}
                        <span class="badge bg-primary">{{ dept }}</span>
                      {% endfor %}
                    </td>
                    
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="8" class="text-center">No clients found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'dashboard/plugins/select2/js/select2.min.js' %}"></script>
<script>
  let deleteClientId = null;

  $('#confirmDeleteModal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);
    deleteClientId = button.data('client-id');
  });

  $('#confirmDeleteBtn').on('click', function () {
    if (deleteClientId) {
      window.location.href = `/tracker/delete-client/${deleteClientId}/`;
    }
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const groupCodeInput = document.getElementById('id_group_code');
  const clientCodeInput = document.getElementById('id_client_code');
  let prefix = '';

  function updateClientCodePrefix(groupCode) {
    prefix = groupCode ? groupCode.trim() : '';
    clientCodeInput.value = prefix;
    setCaretToEnd();
  }

  function setCaretToEnd() {
    requestAnimationFrame(() => {
      clientCodeInput.setSelectionRange(clientCodeInput.value.length, clientCodeInput.value.length);
    });
  }

  groupCodeInput.addEventListener('input', function () {
    updateClientCodePrefix(groupCodeInput.value);
  });

  clientCodeInput.addEventListener('keydown', function (e) {
    // Prevent editing before prefix
    if (clientCodeInput.selectionStart < prefix.length) {
      if (['Backspace', 'Delete', 'ArrowLeft'].includes(e.key)) {
        e.preventDefault();
        setCaretToEnd();
      }
    }
  });

  clientCodeInput.addEventListener('input', function () {
    if (!clientCodeInput.value.startsWith(prefix)) {
      clientCodeInput.value = prefix;
      setCaretToEnd();
    }
  });

  // Initialize if editing
  if (clientCodeInput.value) {
    const existing = clientCodeInput.value;
    prefix = groupCodeInput.value || '';
    if (!existing.startsWith(prefix)) {
      clientCodeInput.value = prefix;
    }
    setCaretToEnd();
  }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const table = document.querySelector('table');
    const filters = table.querySelectorAll('select.column-filter');
    const rows = Array.from(table.querySelector('tbody').rows);

    // Setup dropdown filters
    filters.forEach((filter, colIndex) => {
        const values = new Set();
        rows.forEach(row => {
            const cellText = row.cells[colIndex + 1].textContent.trim();
            if (cellText) values.add(cellText);
        });
        [...values].sort().forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            filter.appendChild(option);
        });

        filter.addEventListener('change', function () {
            const selected = this.value;
            rows.forEach(row => {
                const cell = row.cells[colIndex + 1];
                const show = !selected || cell.textContent.trim() === selected;
                row.style.display = show ? '' : 'none';
            });
        });
    });

    
});
</script>

{% endblock %}
